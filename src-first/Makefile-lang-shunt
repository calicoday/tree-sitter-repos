# lang json makefile without bindings/c stuff. 
# the only repos with bindings/c have their own Makefile currently

VERSION := 0.19.0

# Repository
SRC_DIR := src

# in tree-sitter-typescript:
# git -C src remote get-url origin
# => fatal: cannot change to 'src': No such file or directory
#   [and PARSER_REPO_URL gets empty string]
PARSER_REPO_URL := $(shell git -C $(SRC_DIR) remote get-url origin )
ifeq (, $(PARSER_REPO_URL))
$(error Repo has no $(SRC_DIR). Skipping)
endif

ifeq (, $(PARSER_NAME))
	PARSER_NAME := $(shell basename $(PARSER_REPO_URL))
	PARSER_NAME := $(subst tree-sitter-,,$(PARSER_NAME))
	PARSER_NAME := $(subst .git,,$(PARSER_NAME))
endif

ifeq (, $(PARSER_URL))
	PARSER_URL := $(subst :,/,$(PARSER_REPO_URL))
	PARSER_URL := $(subst git@,https://,$(PARSER_URL))
	PARSER_URL := $(subst .git,,$(PARSER_URL))
endif

UPPER_PARSER_NAME := $(shell echo $(PARSER_NAME) | tr a-z A-Z )

# install directory layout
# PREFIX ?= /usr/local
# INCLUDEDIR ?= $(PREFIX)/include
# LIBDIR ?= $(PREFIX)/lib
# PCLIBDIR ?= $(LIBDIR)/pkgconfig

# SHUNTLIB may differ by project, eg /$(PROJ_NAME) for tree-sitter vs 
# /tree-sitter-lang/$(PROJ_NAME) for langs.
SHUNTLIB ?= /tree-sitter-lang/$(PROJ_NAME)
### TMP!!!
VERS_FULL = '0.55.7'
INCLUDE_NAME := tree_sitter_lang #???
SHUNTINCLUDE ?= /$(INCLUDE_NAME)
# SHUNTINCLUDE ?= /$(INCLUDE_NAME).$(VERS_FULL)

# for later
SRC_C_BINDS := bindings/c
C_BINDS := tree_sitter_$(PARSER_NAME).h
C_BINDS_PKG := tree_sitter_$(PARSER_NAME).pc


# install directory layout
PREFIX ?= /usr/local
INCLUDEDIR ?= $(PREFIX)/include$(SHUNTINCLUDE)
LIBDIR ?= $(PREFIX)/lib$(SHUNTLIB)
PCLIBDIR ?= $(LIBDIR)/pkgconfig

# collect C++ sources, and link if necessary
CPPSRC := $(wildcard $(SRC_DIR)/*.cc)

ifeq (, $(CPPSRC))
	ADDITIONALLIBS := 
else
	ADDITIONALLIBS := -lc++
endif

# collect sources
SRC := $(wildcard $(SRC_DIR)/*.c)
SRC += $(CPPSRC)
OBJ := $(addsuffix .o,$(basename $(SRC)))

# ABI versioning
SONAME_MAJOR := 0
SONAME_MINOR := 0

CFLAGS ?= -O3 -Wall -Wextra -I$(SRC_DIR)
CXXFLAGS ?= -O3 -Wall -Wextra -I$(SRC_DIR)
override CFLAGS += -std=gnu99 -fPIC
override CXXFLAGS += -fPIC

# OS-specific bits
ifeq ($(shell uname),Darwin)
	SOEXT = dylib
	SOEXTVER_MAJOR = $(SONAME_MAJOR).dylib
	SOEXTVER = $(SONAME_MAJOR).$(SONAME_MINOR).dylib
	LINKSHARED := $(LINKSHARED)-dynamiclib -Wl,
	ifneq ($(ADDITIONALLIBS),)
	LINKSHARED := $(LINKSHARED)$(ADDITIONALLIBS),
	endif
	LINKSHARED := $(LINKSHARED)-install_name,$(LIBDIR)/libtree-sitter-$(PARSER_NAME).$(SONAME_MAJOR).dylib,-rpath,@executable_path/../Frameworks
else
	SOEXT = so
	SOEXTVER_MAJOR = so.$(SONAME_MAJOR)
	SOEXTVER = so.$(SONAME_MAJOR).$(SONAME_MINOR)
	LINKSHARED := $(LINKSHARED)-shared -Wl,
	ifneq ($(ADDITIONALLIBS),)
	LINKSHARED := $(LINKSHARED)$(ADDITIONALLIBS),
	endif
	LINKSHARED := $(LINKSHARED)-soname,libtree-sitter-$(PARSER_NAME).so.$(SONAME_MAJOR)
endif
ifneq (,$(filter $(shell uname),FreeBSD NetBSD DragonFly))
	PCLIBDIR := $(PREFIX)/libdata/pkgconfig
endif

all: libtree-sitter-$(PARSER_NAME).a libtree-sitter-$(PARSER_NAME).$(SOEXTVER)
# all: libtree-sitter-$(PARSER_NAME).a libtree-sitter-$(PARSER_NAME).$(SOEXTVER) \
# 	$(C_BINDS) $(C_BINDS_PKG)

libtree-sitter-$(PARSER_NAME).a: $(OBJ)
	$(AR) rcs $@ $^

libtree-sitter-$(PARSER_NAME).$(SOEXTVER): $(OBJ)
	$(CC) $(LDFLAGS) $(LINKSHARED) $^ $(LDLIBS) -o $@
	ln -sf $@ libtree-sitter-$(PARSER_NAME).$(SOEXT)
	ln -sf $@ libtree-sitter-$(PARSER_NAME).$(SOEXTVER_MAJOR)

# choosing underscore for header names. no direct eg but matches dir 
# /usr/local/include/tree_sitter. h and pc inputs are left as they were (hyphen)
# bindings/c/$(PARSER_NAME).h:
# $(SRC_C_BINDS)/tree_sitter_$(PARSER_NAME).h:
$(SRC_C_BINDS)/$(C_BINDS):
	sed -e 's|@UPPER_PARSERNAME@|$(UPPER_PARSER_NAME)|' \
		-e 's|@PARSERNAME@|$(PARSER_NAME)|' \
		$(SRC_C_BINDS)/tree-sitter.h.in > $@
# shd be: ???
# 		$(SRC_C_BINDS)/tree-sitter-$(PARSER_NAME).h.in > $@

# $(SRC_C_BINDS)/tree-sitter-$(PARSER_NAME).pc:
$(SRC_C_BINDS)/$(C_BINDS_PKG):
	sed -e 's|@LIBDIR@|$(LIBDIR)|;s|@INCLUDEDIR@|$(INCLUDEDIR)|;s|@VERSION@|$(VERSION)|' \
		-e 's|=$(PREFIX)|=$${prefix}|' \
		-e 's|@PREFIX@|$(PREFIX)|' \
		-e 's|@ADDITIONALLIBS@|$(ADDITIONALLIBS)|' \
		-e 's|@PARSERNAME@|$(PARSER_NAME)|' \
		-e 's|@PARSERURL@|$(PARSER_REPO_URL)|' \
		$(SRC_C_BINDS)/tree-sitter.pc.in > $@
# shd be: ???
# 		$(SRC_C_BINDS)/tree-sitter-$(PARSER_NAME).pc.in > $@

install: all
	install -d '$(DESTDIR)$(LIBDIR)'
	install -m755 libtree-sitter-$(PARSER_NAME).a '$(DESTDIR)$(LIBDIR)'/libtree-sitter-$(PARSER_NAME).a
	install -m755 libtree-sitter-$(PARSER_NAME).$(SOEXTVER) '$(DESTDIR)$(LIBDIR)'/libtree-sitter-$(PARSER_NAME).$(SOEXTVER)
	ln -sf libtree-sitter-$(PARSER_NAME).$(SOEXTVER) '$(DESTDIR)$(LIBDIR)'/libtree-sitter-$(PARSER_NAME).$(SOEXTVER_MAJOR)
	ln -sf libtree-sitter-$(PARSER_NAME).$(SOEXTVER) '$(DESTDIR)$(LIBDIR)'/libtree-sitter-$(PARSER_NAME).$(SOEXT)

# above
# SRC_C_BINDS := bindings/c
# C_BINDS := tree-sitter-$(PARSER_NAME).h
# C_BINDS_PKG := tree-sitter-$(PARSER_NAME).pc

# install-c-binds: install
installcbinds: install $(SRC_C_BINDS)/$(C_BINDS) $(SRC_C_BINDS)/$(C_BINDS_PKG)
	install -d '$(DESTDIR)$(INCLUDEDIR)'
	install -m644 $(SRC_C_BINDS)/$(C_BINDS) '$(DESTDIR)$(INCLUDEDIR)'/$(C_BINDS)
# 	install -m644 bindings/c/$(PARSER_NAME).h '$(DESTDIR)$(INCLUDEDIR)'/tree_sitter/
	install -d '$(DESTDIR)$(PCLIBDIR)'
	install -m644 $(SRC_C_BINDS)/$(C_BINDS_PKG) '$(DESTDIR)$(PCLIBDIR)'/$(C_BINDS_PKG)

# install-c-binds:
# 	install -d '$(DESTDIR)$(INCLUDEDIR)'/tree_sitter
# 	install -m644 $(C_BINDS) '$(DESTDIR)$(INCLUDEDIR)'/tree_sitter/
# # 	install -m644 bindings/c/$(PARSER_NAME).h '$(DESTDIR)$(INCLUDEDIR)'/tree_sitter/
# 	install -d '$(DESTDIR)$(PCLIBDIR)'
# 	install -m644 $(C_BINDS_PKG) '$(DESTDIR)$(PCLIBDIR)'/

clean:
	rm -f $(OBJ) libtree-sitter-$(PARSER_NAME).a libtree-sitter-$(PARSER_NAME).$(SOEXT) libtree-sitter-$(PARSER_NAME).$(SOEXTVER_MAJOR) libtree-sitter-$(PARSER_NAME).$(SOEXTVER)
	# for c binds:
# 	rm -f bindings/c/$(PARSER_NAME).h bindings/c/tree-sitter-$(PARSER_NAME).pc

.PHONY: all install clean
